name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  GO_VERSION: "1.21"
  KIND_VERSION: "v0.20.0"

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
      
      - name: golangci-lint
        uses: golangci/golangci-lint-action@v4
        with:
          version: latest
          working-directory: control-plane
      
      - name: Helm Lint
        run: |
          helm lint charts/control-plane
          helm lint charts/chaos-agent

  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
      
      - name: Run Tests
        working-directory: control-plane
        run: |
          go test -v -race -coverprofile=coverage.txt -covermode=atomic ./...
      
      - name: Upload Coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./control-plane/coverage.txt
          flags: unittests

  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
      
      - name: Build Control Plane
        working-directory: control-plane
        run: go build -v ./cmd/server
      
      - name: Build Docker Images
        run: |
          docker build -t chaoscraft/control-plane:${{ github.sha }} ./control-plane
          docker build -t chaoscraft/chaos-agent:${{ github.sha }} ./agents/kubernetes

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
      
      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'

  e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: [lint, test, build]
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
      
      - name: Install kind
        run: |
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/${{ env.KIND_VERSION }}/kind-linux-amd64
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind
      
      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'v1.28.0'
      
      - name: Run E2E Tests
        run: |
          chmod +x scripts/e2e-test.sh
          ./scripts/e2e-test.sh
      
      - name: Collect Logs on Failure
        if: failure()
        run: |
          kubectl get pods -A
          kubectl logs -n chaoscraft -l app=chaoscraft-control-plane --tail=100
          kubectl logs -n chaoscraft -l app=chaoscraft-agent --tail=100
