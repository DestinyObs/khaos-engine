apiVersion: chaos.chaoscraft.io/v1alpha1
kind: ChaosExperiment
metadata:
  name: pod-kill-demo
  namespace: demo
spec:
  # Target selector
  selector:
    labelSelectors:
      app: nginx
      chaos-enabled: "true"
    namespaces:
      - demo

  # Chaos configuration
  chaos:
    type: pod-kill
    podKill:
      signal: SIGTERM  # SIGTERM or SIGKILL
      count: 1         # Number of pods to kill
      interval: 10s    # Interval between kills
      mode: random     # random, fixed, or percentage

  # Experiment schedule
  schedule:
    duration: 60s
    startTime: ""     # ISO8601 timestamp, empty = start immediately
    cron: ""          # Optional: cron schedule for recurring experiments

  # Blast radius control
  blastRadius:
    maxImpact: 0.33   # Maximum 33% of pods
    progressiveRamp: true
    rampSteps: 3
    rampInterval: 20s

  # Steady-state hypothesis
  steadyState:
    promQL: |
      (
        kube_deployment_status_replicas_available{deployment="nginx",namespace="demo"} 
        / 
        kube_deployment_spec_replicas{deployment="nginx",namespace="demo"}
      )
    threshold: 0.66   # At least 66% availability
    probeInterval: 5s

  # Rollback configuration
  rollback:
    enabled: true
    triggers:
      - type: steady-state-violation
      - type: error-rate-spike
        threshold: 0.5  # 50% error rate
      - type: manual

  # Metadata
  description: "Demo experiment: Kill one nginx pod to test resilience"
  tags:
    - demo
    - nginx
    - pod-chaos
  owner: devops-team
